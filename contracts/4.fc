{-
  TASK 4 - Caesar Cipher
  Implement a Caesar cipher encryption andecryption functions.
  The input is a string (https://docs.ton.org/develop/smart-contracts/guidelines/internal-messages#simple-message-with-comment)
  where the text is encryptein a cell (after 32bit 00000000 prefix flag), the algorithm rotates the characters anthe last ASCII
  character shoulgo to the beginning. Return new text encodein cell.
-}

() recv_internal() {
}

int f(int) asm """
    // x
    1 GETGLOB // x D
    8 PUSHINT // x D 8
    DICTUGET // s ?
    DROP // s
    8 LDU // x s
    DROP // x
""";

() help(int) impure asm """
    // d
    B{b5ee9c72420202bd000100001123000002012000c20001020120002700020201d4001500030101200004020166000d000502012000090006020120017a00070201480225000800034798020120000a00a0020120000b0149020120000c01da000357a80201200011000e0201200185000f0201480241001000034598020120001200a902012000130153020120001401ea000355a80101200016020166001f0017020120001b0018020120019200190201480260001a00034788020120001c00b4020120001d015f020120001e01fc0003579802012000230020020120019d00210201480293002200034588020120002400bd020120002501690201200026020d0003559802012000730028020120004e0029020120003c002a010120002b0201660034002c0201200030002d02012001ab002e0201480226002f00034778020120003100cc0201200032017802012000330221000357880201200038003502012001b600360201480242003700034578020120003900d5020120003a0183020120003b023d00035588010120003d0201660046003e0201200042003f02012001c300400201480263004100034768020120004300e0020120004401900201200045025b00035778020120004a004702012001ce00480201480296004900034568020120004b00e9020120004c019b020120004d028e000355780201200061004f0101200050020166005900510201200055005202012001df00530201480228005400034758020120005600f5020120005701a90201200058022500035768020120005d005a02012001ef005b0201480244005c00034558020120005e00fe020120005f01b402012000600241000355680101200062020166006b00630201200067006402012002020065020148026700660003474802012000680109020120006901c1020120006a026000035758020120006f006c0201200213006d020148029a006e0003454802012000700112020120007101cc020120007202930003555802012000990074020120008700750101200076020166007f0077020120007b0078020120022b00790201480229007a00034738020120007c011f020120007d01dc020120007e0226000357480201200083008002012002470081020148024500820003453802012000840128020120008501ec0201200086024200035548010120008802016600910089020120008d008a020120026e008b020148026a008c00034728020120008e0133020120008f01ff02012000900263000357380201200095009202012002a10093020148029d0094000345280201200096013c02012000970210020120009802960003553802012000ae009a010120009b02016600a5009c02012000a1009d02012000a0009e020148022d009f0003471802012001e301e102012000a2014802012000a3022402012000a402280003572802012000aa00a602012000a900a7020148024900a80003451802012001f301f102012000ab015202012000ac024002012000ad02440003552801012000af02016600b900b002012000b500b102012000b400b2020148027000b3000347080201200206020402012000b6015e02012000b7025f02012000b802670003571802012000be00ba02012000bd00bb02014802a300bc000345080201200217021502012000bf016802012000c0029202012000c1029a00035518020120016e00c3020120011700c402012000ee00c502012000da00c601012000c702016600d100c802012000cd00c902012000cc00ca020148022e00cb000346f80201200233022f02012000ce017702012000cf01dd02012000d002290003570802012000d600d202012000d500d3020148024a00d4000344f8020120024f024b02012000d7018202012000d801ed02012000d902450003550801012000db02016600e500dc02012000e100dd02012000e000de020148027300df000346e8020120027e027602012000e2018f02012000e3020002012000e4026a000356f802012000ea00e602012000e900e702014802a600e8000344e802012002b102a902012000eb019a02012000ec021102012000ed029d000354f8020120010300ef01012000f002016600fa00f102012000f600f202012000f500f3020148023000f4000346d8020120014901e302012000f701a802012000f8022702012000f9022d000356e802012000ff00fb02012000fe00fc020148024c00fd000344d8020120015301f3020120010001b30201200101024302012001020249000354e80101200104020166010e0105020120010a01060201200109010702014802770108000346c8020120015f0206020120010b01c0020120010c0266020120010d0270000356d80201200113010f0201200112011002014802aa0111000344c802012001690217020120011401cb02012001150299020120011602a3000354d802012001410118020120012d0119010120011a0201660124011b0201200120011c020120011f011d0201480231011e000346b802012001780233020120012101db020120012201e00201200123022e000356c80201200129012502012001280126020148024d0127000344b80201200183024f020120012a01eb020120012b01f0020120012c024a000354c8010120012e0201660138012f0201200134013002012001330131020148027a0132000346a80201200190027e020120013501fe0201200136020302012001370273000356b8020120013d0139020120013c013a02014802ad013b000344a8020120019b02b1020120013e020f020120013f0214020120014002a6000354b8020120015801420101200143020166014e0144020120014a014502012001480146020148023401470003469802012001a9014902012002370235020120014b0223020120014c022c020120014d0230000356a80201200154014f02012001520150020148025001510003449802012001b40153020120025302510201200155023f020120015602480201200157024c000354a801012001590201660164015a0201200160015b020120015e015c020148027f015d0003468802012001c1015f020120028602820201200161025e0201200162026f0201200163027700035698020120016a01650201200168016602014802b201670003448802012001cc016902012002b902b5020120016b0291020120016c02a2020120016d02aa0003549802012001d2016f02012001a10170020120018901710101200172020166017e01730201200179017402012001770175020148023501760003467802012001dc017802012001da0237020120017b017a02012001e001dd020120017c01e1020120017d0231000356880201200184017f02012001820180020148025101810003447802012001ec018302012001ea02530201200186018502012001f001ed020120018701f10201200188024d00035488010120018a0201660196018b0201200191018c020120018f018d0201480282018e0003466802012001ff019002012001fc02860201200193019202012002030200020120019402040201200195027a00035678020120019c0197020120019a019802014802b50199000344680201200210019b020120020d02b9020120019e019d02012002140211020120019f021502012001a002ad0003547802012001ba01a201012001a302016601af01a402012001aa01a502012001a801a6020148023701a700034658020120022401a9020120022101da02012001ac01ab020120022c022702012001ad022f02012001ae02340003566802012001b501b002012001b301b1020148025301b200034458020120024001b4020120023d01ea02012001b701b60201200248024302012001b8024b02012001b902500003546801012001bb02016601c701bc02012001c201bd02012001c001be020148028601bf00034648020120025f01c1020120025b01fc02012001c401c3020120026f026602012001c5027602012001c6027f0003565802012001cd01c802012001cb01c902014802b901ca00034448020120029201cc020120028e020d02012001cf01ce02012002a2029902012001d002a902012001d102b200035458020120021a01d302012001f601d401012001d502016601e601d602012001de01d702012001db01d802014801da01d90003463802012001fd028802012001dd01dc020120022502210201200228022602012001e201df02012001e101e0020120022d02290201200230022e02012001e401e30201200234023102012001e502350003564802012001ee01e702012001eb01e802014801ea01e900034438020120020e02bb02012001ed01ec0201200241023d0201200244024202012001f201ef02012001f101f002012002490245020120024c024a02012001f401f30201200250024d02012001f502510003544801012001f7020166020901f8020120020101f902012001fe01fa02014801fc01fb00034628020120022201fd00031860020120020001ff0201200260025b0201200267026302012002050202020120020402030201200270026a0201200277027302012002070206020120027f027a02012002080282000356380201200212020a020120020f020b020148020d020c00034428020120023e020e00031060020120021102100201200293028e020120029a0296020120021602130201200215021402012002a3029d02012002aa02a60201200218021702012002b202ad020120021902b5000354380201200255021b010120021c0201660239021d020120022a021e0201200223021f0201480221022000034618020120025c022200031ea002012002270224020120022602250201200261025d020120026402620201200229022802012002680265020120026b02690201200232022b020120022f022c020120022e022d0201200271026c020120027402720201200231023002012002780275020120027b027902012002360233020120023502340201200280027c020120028302810201200238023702012002870284000356280201200246023a020120023f023b020148023d023c00034418020120028f023e000316a00201200243024002012002420241020120029402900201200297029502012002450244020120029b0298020120029e029c020120024e0247020120024b0248020120024a024902012002a4029f02012002a702a5020120024d024c02012002ab02a802012002ae02ac0201200252024f0201200251025002012002b302af02012002b602b40201200254025302012002ba02b7000354280101200256020166028a0257020120026d0258020120025e0259020148025b025a000347a8020120025d025c00031e6000031e200201200266025f020120026302600201200262026100031de000031da00201200265026400031d6000031d20020120026a02670201200269026800031ce000031ca0020120026c026b00031c6000031c20020120027d026e0201200276026f020120027302700201200272027100031be000031ba00201200275027400031b6000031b20020120027a02770201200279027800031ae000031aa0020120027c027b00031a6000031a200201200285027e0201200282027f02012002810280000319e0000319a00201200284028300031960000319200201200289028602012002880287000318e0000318a00003561802012002a0028b0201200291028c020148028e028d000345a80201200290028f0003166000031620020120029902920201200296029302012002950294000315e0000315a0020120029802970003156000031520020120029d029a020120029c029b000314e0000314a0020120029f029e000314600003142002012002b002a102012002a902a202012002a602a302012002a502a4000313e0000313a002012002a802a7000313600003132002012002ad02aa02012002ac02ab000312e0000312a002012002af02ae000312600003122002012002b802b102012002b502b202012002b402b3000311e0000311a002012002b702b6000311600003112002012002bc02b902012002bb02ba000310e0000310a000035418d8c8021b} B>boc PUSHREF
    // d D
    5 PUSHINT // d D 5
    DICTUGETREF // c ?
    DROP // c
    1 SETGLOB //
""";

(builder) store_caesar(slice s) {
    builder b = begin_cell();
    repeat (s.slice_bits() / 8) {
        int x = s~load_uint(8);
        ;; if ((x >= 65) & (x <= 90)) {
        ;;     x = (x + d + 13) % 26 + 65;
        ;; } elseif ((x >= 97) & (x <= 122)) {
        ;;     x = (x + d + 7) % 26 + 97;
        ;; }
        if ((x >= 65) & (x <= 122)) {
            x = f(x);
        }
        b~store_uint(x, 8);
    }
    if (s.slice_refs_empty?()) {
        return b;
    }
    return b.store_ref(store_caesar(s.preload_ref().begin_parse()).end_cell());
}

;; testable
(cell) caesar_cipher_encrypt(int shift, cell text) method_id {
    help((shift + 52) % 26);
    return begin_cell()
        .store_uint(0, 32)
        .store_builder(store_caesar(text.begin_parse().skip_bits(32)))
    .end_cell();
}

;; testable
(cell) caesar_cipher_decrypt(int shift, cell text) method_id {
    help((52 - shift) % 26);
    return begin_cell()
        .store_uint(0, 32)
        .store_builder(store_caesar(text.begin_parse().skip_bits(32)))
    .end_cell();
}