{-
  TASK 4 - Caesar Cipher
  Implement a Caesar cipher encryption andecryption functions.
  The input is a string (https://docs.ton.org/develop/smart-contracts/guidelines/internal-messages#simple-message-with-comment)
  where the text is encryptein a cell (after 32bit 00000000 prefix flag), the algorithm rotates the characters anthe last ASCII
  character shoulgo to the beginning. Return new text encodein cell.
-}

() recv_internal() {
}

int f(int) asm """
    // x
    1 GETGLOB // x D
    8 PUSHINT // x D 8
    DICTUGET // s ?
    DROP // s
    8 LDU // x s
    DROP // x
""";

() help(int) impure asm """
    // d
    B{b5ee9c72420202b8000100001214000002012000b60001020120002500020201d4001400030101200004020166000e0005020120000a0006020120016000070201200008023d0201200208000902012002490246020120000b0099020120000c0133020120000d01bf020120027802470201200013000f020120016b00100201200011027c0201200224001202012002880285020120013d016c0101200015020166001f0016020120001b0017020120017700180201200019023d020120024d001a020120024a0246020120001c00ab020120001d0147020120001e01e10201200278024902012000240020020120018300210201200022027c020120028c00230201200289028502012001510184020120006d0026020120004a00270201200039002801012000290201660033002a020120002f002b0201200190002c020120002d023d0201200209002e020120024e0246020120003000c10201200031015e020120003202050201200278024a02012000380034020120019c00350201200036027c02012002250037020120028d02850201200169019d010120003a0201660044003b0201200040003c02012001a8003d020120003e023d0201200250003f020120024f0246020120004100d302012000420175020120004302480201200278024e0201200049004502012001b400460201200047027c020120028f0048020120028e0285020120018001b5020120005c004b010120004c0201660056004d0201200052004e02012001c4004f0201200050023d020120020b005102012002510246020120005300e60201200054018e020120005502080201200278024f020120005b005702012001d400580201200059027c0201200227005a02012002900285020120019901d7010120005d0201660067005e0201200063005f02012001e600600201200061023d0201200254006202012002520246020120006400f8020120006501a60201200066024d02012002780251020120006c006802012001f70069020120006a027c0201200293006b0201200291028502012001b101fa0201200091006e0201200080006f0101200070020166007a007102012000760072020120020e00730201200074023d020120020c0075020120025502460201200077010c020120007801c10201200079020902012002780252020120007f007b020120022a007c020120007d027c0201200228007e0201200294028502012001d002310101200081020166008b008202012000870083020120025b00840201200085023d02012002570086020120025602460201200088011e020120008901e3020120008a0250020120027802550201200090008c020120029a008d020120008e027c0201200296008f0201200295028502012001f3012802012000a400920101200093020166009e0094020120009a0095020120009900960201200097023d020120021000980201200258024602012001c801c6020120009b0132020120009c0207020120009d020b0201200278025602012000a3009f020120016c00a002012000a1027c020120022c00a2020120029702850201200222013d01012000a502016600b000a602012000ac00a702012000ab00a802012000a9023d020120025d00aa0201200259024602012001ea01e802012000ad014602012000ae024c02012000af02540201200278025802012000b500b1020120018400b202012000b3027c020120029c00b402012002980285020120028a0151020120015300b7020120010300b802012000de00b902012000cc00ba01012000bb02016600c600bc02012000c200bd02012000c100be02012000bf023d020120021100c0020120025e02460201200216021202012000c3015d02012000c401c202012000c5020c0201200278025902012000cb00c7020120019d00c802012000c9027c020120022d00ca020120029d0285020120016b016901012000cd02016600d800ce02012000d400cf02012000d300d002012000d1023d020120026000d2020120025f0246020120026b026302012000d5017402012000d601e402012000d702570201200278025e02012000dd00d902012001b500da02012000db027c020120029f00dc020120029e02850201200183018002012000f100df01012000e002016600eb00e102012000e700e202012000e600e302012000e4023d020120021300e502012002610246020120013301c802012000e8018d02012000e9020a02012000ea02100201200278025f02012000f000ec02012001d700ed02012000ee027c020120022f00ef02012002a00285020120019c019901012000f202016600fd00f302012000f900f402012000f800f502012000f6023d020120026400f702012002620246020120014701ea02012000fa01a502012000fb025302012000fc025d02012002780261020120010200fe02012001fa00ff0201200100027c02012002a3010102012002a1028502012001b401b1020120012a010402012001170105010120010602016601110107020120010d0108020120010c0109020120010a023d0201200214010b02012002650246020120015e0216020120010e01c0020120010f01c5020120011002110201200278026202012001160112020120023101130201200114027c0201200230011502012002a4028502012001d401d0010120011802016601230119020120011f011a020120011e011b020120011c023d0201200267011d020120026602460201200175026b020120012001e2020120012101e7020120012202600201200278026502012001290124020120012801250201200126027c02012002a6012702012002a50285020120018102aa02012001f701f3020120013f012b010120012c0201660138012d0201200134012e0201200132012f0201200130023d0201200217013102012002680246020120018e0133020120021a0218020120013502060201200136020f0201200137021302012002780266020120013e0139020120013d013a020120013b027c0201200233013c02012002a70285020120019a01d9020120022a02220101200140020166014c014102012001480142020120014601430201200144023d020120026c01450201200269024602012001a601470201200273026f0201200149024b020120014a025c020120014b0264020120027802680201200152014d0201200151014e020120014f027c02012002ab015002012002a8028502012001b201fc020120029a028a02012001b6015402012001850155020120016d0156010120015702016601640158020120015f0159020120015d015a020120015b023d0201200218015c020120026d024602012001c1015e02012001bf021a0201200161016002012001c501c2020120016201c60201200163021402012002780269020120016a0165020120016901660201200167027c0201200234016802012002ac028502012001d10235020120016c016b02012001d501d202012001d801d6010120016e020166017b016f02012001760170020120017401710201200172023d020120026f0173020120026e024602012001e3017502012001e102730201200178017702012001e701e4020120017901e8020120017a02670201200278026d0201200182017c0201200180017d020120017e027c02012002ae017f02012002ad028502012001f4018102012001f202b20201200184018302012001f801f502012001fb01f9020120019e0186010120018702016601940188020120018f0189020120018d018a020120018b023d020120021a018c020120027002460201200207018e020120020501bf02012001910190020120020f020a02012001920212020120019302170201200278026e020120019b0195020120019901960201200197027c0201200236019802012002af02850201200223019a02012002210237020120019d019c020120022b02260201200232022e010120019f02016601ac01a002012001a701a102012001a501a202012001a3023d020120027301a402012002710246020120024c01a6020120024801e102012001a901a8020120025c025302012001aa026302012001ab026c0201200278027002012001b301ad02012001b101ae02012001af027c02012002b201b002012002b00285020120028b01b2020120028701f202012001b501b4020120029b029202012002aa02a202012001fd01b702012001da01b801012001b902016601cb01ba02012001c301bb02012001c001bc02012001bd023d02012001bf01be020120027402460201200277027502012001c201c102012002080205020120020b020902012001c701c402012001c601c50201200210020c0201200213021102012001c901c80201200217021402012001ca02180201200278027102012001d301cc02012001d001cd02012001ce027c020120023701cf02012002b3028502012001d201d1020120022402210201200227022502012001d701d402012001d601d5020120022c0228020120022f022d02012001d901d8020120023302300201200236023401012001db02016601ed01dc02012001e501dd02012001e201de02012001df023d02012001e101e0020120027502460201200247027702012001e401e3020120024d02480201200254025002012001e901e602012001e801e7020120025d02570201200264026002012001eb01ea020120026c026702012001ec026f0201200278027402012001f601ee02012001f301ef02012001f0027c02012001f201f102012002b40285020120028602b602012001f501f4020120028c02870201200293028f02012001fa01f702012001f901f8020120029c029602012002a3029f02012001fc01fb02012002ab02a602012002b202ae020120023801fe01012001ff020166021c0200020120020d0201020120020602020201200203023d020120020502040201200277024602012002490247020120020a020702012002090208020120024e024a0201200251024f020120020c020b02012002550252020120025802560201200215020e0201200212020f02012002110210020120025e02590201200261025f0201200214021302012002650262020120026802660201200219021602012002180217020120026d02690201200270026e020120021b021a02012002740271020120027802750201200229021d0201200222021e020120021f027c0201200221022002012002b60285020120028802860201200226022302012002250224020120028d02890201200290028e0201200228022702012002940291020120029702950201200231022a020120022e022b020120022d022c020120029d029802012002a0029e0201200230022f02012002a402a102012002a702a5020120023502320201200234023302012002ac02a802012002af02ad0201200237023602012002b302b002012002b602b401012002390201660279023a020120025a023b020120024b023c0201200244023d0201200241023e0201200240023f00031fe000031fa00201200243024200031f6000031f20020120024802450201200247024600031ee000031ea0020120024a024900031e6000031e200201200253024c0201200250024d020120024f024e00031de000031da00201200252025100031d6000031d20020120025702540201200256025500031ce000031ca00201200259025800031c6000031c20020120026a025b0201200263025c0201200260025d020120025f025e00031be000031ba00201200262026100031b6000031b20020120026702640201200266026500031ae000031aa00201200269026800031a6000031a200201200272026b020120026f026c020120026e026d000319e0000319a00201200271027000031960000319200201200276027302012002750274000318e0000318a00201200278027700031860000318200201200299027a020120028a027b0201200283027c0201200280027d020120027f027e000317e0000317a00201200282028100031760000317200201200287028402012002860285000316e0000316a00201200289028800031660000316200201200292028b020120028f028c020120028e028d000315e0000315a00201200291029000031560000315200201200296029302012002950294000314e0000314a002012002980297000314600003142002012002a9029a02012002a2029b020120029f029c020120029e029d000313e0000313a002012002a102a0000313600003132002012002a602a302012002a502a4000312e0000312a002012002a802a7000312600003122002012002b102aa02012002ae02ab02012002ad02ac000311e0000311a002012002b002af000311600003112002012002b502b202012002b402b3000310e0000310a002012002b702b600031060000310204f1cc3f5} B>boc PUSHREF
    // d D
    5 PUSHINT // d D 5
    DICTUGETREF // c ?
    DROP // c
    1 SETGLOB //
""";

(builder) store_caesar(slice s) {
    builder b = begin_cell();
    repeat (s.slice_bits() / 8) {
        int x = s~load_uint(8);
        ;; if ((x >= 65) & (x <= 90)) {
        ;;     x = (x + d + 13) % 26 + 65;
        ;; } elseif ((x >= 97) & (x <= 122)) {
        ;;     x = (x + d + 7) % 26 + 97;
        ;; }
        if (x & 64 & (x <= 122)) {
            x = f(x);
        }
        b~store_uint(x, 8);
    }
    if (s.slice_refs_empty?()) {
        return b;
    }
    return b.store_ref(store_caesar(s.preload_ref().begin_parse()).end_cell());
}

;; testable
(cell) caesar_cipher_encrypt(int shift, cell text) method_id {
    help((shift + 52) % 26);
    return begin_cell()
        .store_uint(0, 32)
        .store_builder(store_caesar(text.begin_parse().skip_bits(32)))
    .end_cell();
}

;; testable
(cell) caesar_cipher_decrypt(int shift, cell text) method_id {
    help((52 - shift) % 26);
    return begin_cell()
        .store_uint(0, 32)
        .store_builder(store_caesar(text.begin_parse().skip_bits(32)))
    .end_cell();
}