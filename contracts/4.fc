{-
  TASK 4 - Caesar Cipher
  Implement a Caesar cipher encryption andecryption functions.
  The input is a string (https://docs.ton.org/develop/smart-contracts/guidelines/internal-messages#simple-message-with-comment)
  where the text is encryptein a cell (after 32bit 00000000 prefix flag), the algorithm rotates the characters anthe last ASCII
  character shoulgo to the beginning. Return new text encodein cell.
-}

() recv_internal() {
}

int f(int) asm """
    // x
    1 GETGLOB // x D
    8 PUSHINT // x D 8
    DICTUGET // s ?
    DROP // s
    8 LDU // x s
    DROP // x
""";

() help(int) impure asm """
    // d
    B{b5ee9c72420203020001000013cf000002012000d60001020120002b00020201d4001700030101200004020166000e0005020120000a0006020120019f0007020120000802890201200253000902012002950292020120000b00b1020120000c016a020120000d020702012002c402930201200013000f02012001ab0010020120001102c80201200270001202012002d402d1020120001400bb0201200015017502012000160218000355a8010120001802016600220019020120001e001a02012001b9001b020120001c02890201200299001d02012002960292020120001f00c7020120002001820201200021022b02012002c402950201200027002302012001c50024020120002502c802012002d8002602012002d502d1020120002800d10201200029018d020120002a023c00035598020120007f002c0201200056002d0201200042002e010120002f020166003900300201200035003102012001d400320201200033028902012002540034020120029a0292020120003600e10201200037019d0201200038025002012002c40296020120003e003a02012001e0003b020120003c02c80201200271003d02012002d902d1020120003f00eb020120004001a90201200041026d000355880101200043020166004d00440201200049004502012001ee004602012000470289020120029c0048020120029b0292020120004a00f7020120004b01b7020120004c029402012002c4029a0201200052004e02012001fa004f020120005002c802012002db005102012002da02d102012000530101020120005401c3020120005502d300035578020120006b0057010120005802016600620059020120005e005a020120020c005b020120005c02890201200256005d020120029d0292020120005f010e020120006001d20201200061025302012002c4029b02012000670063020120021d0064020120006502c80201200273006602012002dc02d102012000680118020120006901de020120006a027000035568010120006c0201660076006d0201200072006e0201200230006f0201200070028902012002a00071020120029e029202012000730124020120007401ec0201200075029902012002c4029d020120007b007702012002410078020120007902c802012002df007a02012002dd02d1020120007c012e020120007d01f8020120007e02d80003555802012000a90080020120009500810101200082020166008c00830201200088008402012002590085020120008602890201200257008702012002a102920201200089013c020120008a0209020120008b025402012002c4029e0201200091008d0201200276008e020120008f02c80201200274009002012002e002d1020120009201460201200093021a0201200094027100035548010120009602016600a00097020120009c009802012002a70099020120009a028902012002a3009b02012002a20292020120009d0152020120009e022d020120009f029c02012002c402a102012000a500a102012002e600a202012000a302c802012002e200a402012002e102d102012000a6015c02012000a7023e02012000a802db0003553802012000c000aa01012000ab02016600b600ac02012000b200ad02012000b100ae02012000af0289020120025b00b002012002a402920201200210020e02012000b3016902012000b4025202012000b5025602012002c402a202012000bc00b702012000bb00b802012000b902c8020120027800ba02012002e302d10201200221021f02012000bd017402012000be026f02012000bf02730003552801012000c102016600cc00c202012000c800c302012000c700c402012000c5028902012002a900c602012002a502920201200234023202012000c9018102012000ca029802012000cb02a002012002c402a402012000d200cd02012000d100ce02012000cf02c802012002e800d002012002e402d10201200245024302012000d3018c02012000d402d702012000d502df00035518020120019200d7020120013300d8020120010600d902012000f000da01012000db02016600e600dc02012000e200dd02012000e100de02012000df0289020120025c00e002012002aa02920201200261025d02012000e3019c02012000e4020a02012000e5025702012002c402a502012000ec00e702012000eb00e802012000e902c8020120027900ea02012002e902d1020120027e027a02012000ed01a802012000ee021b02012000ef02740003550801012000f102016600fc00f202012000f800f302012000f700f402012000f5028902012002ac00f602012002ab029202012002b702af02012000f901b602012000fa022e02012000fb02a302012002c402aa020120010200fd020120010100fe02012000ff02c802012002eb010002012002ea02d102012002f602ee020120010301c20201200104023f020120010502e2000354f8020120011d0107010120010802016601130109020120010f010a020120010e010b020120010c0289020120025e010d02012002ad0292020120016a0210020120011001d1020120011102550201200112025b02012002c402ab0201200119011402012001180115020120011602c8020120027b011702012002ec02d102012001750221020120011a01dd020120011b0272020120011c0278000354e8010120011e0201660129011f02012001250120020120012401210201200122028902012002b0012302012002ae029202012001820234020120012601eb0201200127029f020120012802a902012002c402ad020120012f012a020120012e012b020120012c02c802012002ef012d02012002ed02d1020120018d0245020120013001f7020120013102de020120013202e8000354d802012001610134020120014b0135010120013602016601410137020120013d0138020120013c0139020120013a0289020120025f013b02012002b10292020120019d0261020120013e0208020120013f020d0201200140025c02012002c402ae0201200147014202012001460143020120014402c8020120027c014502012002f002d102012001a9027e020120014802190201200149021e020120014a0279000354c8010120014c0201660157014d0201200153014e0201200152014f0201200150028902012002b3015102012002b2029202012001b702b70201200154022c02012001550231020120015602ac02012002c402b1020120015d0158020120015c0159020120015a02c802012002f2015b02012002f102d102012001c302f6020120015e023d020120015f0242020120016002eb000354b8020120017a01620101200163020166016f0164020120016b016502012001690166020120016702890201200262016802012002b4029202012001d2016a02012002650263020120016c0251020120016d025a020120016e025e02012002c402b20201200176017002012001740171020120017202c8020120027f017302012002f302d102012001de0175020120028202800201200177026e020120017802770201200179027b000354a8010120017b0201660187017c0201200183017d0201200181017e020120017f028902012002b8018002012002b5029202012001ec018202012002bf02bb02012001840297020120018502a8020120018602b002012002c402b4020120018e0188020120018c0189020120018a02c802012002f7018b02012002f402d102012001f8018d02012002fe02fa020120018f02d6020120019002e7020120019102ef0003549802012001fe019302012001c9019402012001af0195010120019602016601a30197020120019e0198020120019c0199020120019a02890201200263019b02012002b902920201200209019d0201200207026502012001a0019f020120020d020a02012001a1020e02012001a2025f02012002c402b502012001aa01a402012001a801a502012001a602c8020120028001a702012002f802d1020120021a01a90201200218028202012001ac01ab020120021e021b02012001ad021f02012001ae027c0003548801012001b002016601bd01b102012001b801b202012001b601b302012001b4028902012002bb01b502012002ba0292020120022d01b7020120022b02bf02012001ba01b90201200231022e02012001bb023202012001bc02b302012002c402b902012001c401be02012001c201bf02012001c002c802012002fa01c102012002f902d1020120023e01c3020120023c02fe02012001c601c50201200242023f02012001c7024302012001c802f20003547802012001e401ca01012001cb02016601d801cc02012001d301cd02012001d101ce02012001cf0289020120026501d002012002bc0292020120025201d20201200250020702012001d501d4020120025a025502012001d6025d02012001d7026202012002c402ba02012001df01d902012001dd01da02012001db02c8020120028201dc02012002fb02d1020120026f01de020120026d021802012001e101e00201200277027202012001e2027a02012001e3027f0003546801012001e502016601f201e602012001ed01e702012001eb01e802012001e9028902012002bf01ea02012002bd0292020120029801ec0201200294022b02012001ef01ee02012002a8029f02012001f002af02012001f102b802012002c402bc02012001f901f302012001f701f402012001f502c802012002fe01f602012002fc02d102012002d701f802012002d3023c02012001fb01fa02012002e702de02012001fc02ee02012001fd02f700035458020120024801ff02012002240200010120020102016602130202020120020b020302012002080204020120020502890201200207020602012002c0029202012002c302c1020120020a02090201200253025002012002560254020120020f020c020120020e020d020120025b0257020120025e025c020120021102100201200262025f0201200212026302012002c402bd020120021c021402012002190215020120021602c80201200218021702012002ff02d1020120026c0300020120021b021a0201200270026d020120027302710201200220021d020120021f021e02012002780274020120027b027902012002220221020120027f027c0201200223028000035448010120022502016602370226020120022f0227020120022c022802012002290289020120022b022a02012002c10292020120029302c3020120022e022d0201200299029402012002a0029c020120023302300201200232023102012002a902a302012002b002ac0201200235023402012002b802b3020120023602bb02012002c402c002012002400238020120023d0239020120023a02c8020120023c023b020120030002d102012002d2026c020120023f023e02012002d802d302012002df02db020120024402410201200243024202012002e802e202012002ef02eb0201200246024502012002f702f2020120024702fa0003543802012002840249010120024a0201660267024b0201200258024c0201200251024d020120024e02890201200250024f02012002c30292020120029502930201200255025202012002540253020120029a0296020120029d029b0201200257025602012002a1029e02012002a402a202012002600259020120025d025a020120025c025b02012002aa02a502012002ad02ab020120025f025e02012002b102ae02012002b402b2020120026402610201200263026202012002b902b502012002bc02ba0201200266026502012002c002bd02012002c402c102012002750268020120026e0269020120026a02c8020120026d026b020120026c02d10003106002012002d402d20201200272026f0201200271027002012002d902d502012002dc02da0201200274027302012002e002dd02012002e302e1020120027d0276020120027a02770201200279027802012002e902e402012002ec02ea020120027c027b02012002f002ed02012002f302f10201200281027e0201200280027f02012002f802f402012002fb02f90201200283028202012002ff02fc00035428010120028502016602c5028602012002a602870201200297028802012002900289020120028d028a020120028c028b00031fe000031fa0020120028f028e00031f6000031f20020120029402910201200293029200031ee000031ea00201200296029500031e6000031e20020120029f0298020120029c0299020120029b029a00031de000031da0020120029e029d00031d6000031d2002012002a302a002012002a202a100031ce000031ca002012002a502a400031c6000031c2002012002b602a702012002af02a802012002ac02a902012002ab02aa00031be000031ba002012002ae02ad00031b6000031b2002012002b302b002012002b202b100031ae000031aa002012002b502b400031a6000031a2002012002be02b702012002bb02b802012002ba02b9000319e0000319a002012002bd02bc000319600003192002012002c202bf02012002c102c0000318e0000318a002012002c402c3000318600003182002012002e502c602012002d602c702012002cf02c802012002cc02c902012002cb02ca000317e0000317a002012002ce02cd000317600003172002012002d302d002012002d202d1000316e0000316a002012002d502d4000316600003162002012002de02d702012002db02d802012002da02d9000315e0000315a002012002dd02dc000315600003152002012002e202df02012002e102e0000314e0000314a002012002e402e3000314600003142002012002f502e602012002ee02e702012002eb02e802012002ea02e9000313e0000313a002012002ed02ec000313600003132002012002f202ef02012002f102f0000312e0000312a002012002f402f3000312600003122002012002fd02f602012002fa02f702012002f902f8000311e0000311a002012002fc02fb0003116000031120020120030102fe020120030002ff000310e0000310a000035418cd5ff899} B>boc PUSHREF
    // d D
    5 PUSHINT // d D 5
    DICTUGETREF // c ?
    DROP // c
    1 SETGLOB //
""";

(builder) store_caesar(slice s, int d) {
    builder b = begin_cell();
    repeat (s.slice_bits() / 8) {
        int x = s~load_uint(8);
        ;; if ((x >= 65) & (x <= 90)) {
        ;;     x = (x + d + 13) % 26 + 65;
        ;; } elseif ((x >= 97) & (x <= 122)) {
        ;;     x = (x + d + 7) % 26 + 97;
        ;; }
        if (x & 64) {
            x = f(x);
        }
        b~store_uint(x, 8);
    }
    if (s.slice_refs_empty?()) {
        return b;
    }
    return b.store_ref(store_caesar(s.preload_ref().begin_parse(), d).end_cell());
}

;; testable
(cell) caesar_cipher_encrypt(int shift, cell text) method_id {
    help((shift + 26) % 26);
    return begin_cell()
        .store_uint(0, 32)
        .store_builder(store_caesar(text.begin_parse().skip_bits(32), shift))
    .end_cell();
}

;; testable
(cell) caesar_cipher_decrypt(int shift, cell text) method_id {
    help((26 - shift) % 26);
    return begin_cell()
        .store_uint(0, 32)
        .store_builder(store_caesar(text.begin_parse().skip_bits(32), - shift))
    .end_cell();
}